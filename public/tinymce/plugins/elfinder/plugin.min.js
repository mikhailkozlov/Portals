tinymce.PluginManager.add("elfinder", function (editor, url) {

    editor.settings.file_browser_callback = function (id, value, type, win) {

        $('<div />').dialogelfinder({
            url: '/admin/files/manager',
            rememberLastDir: false,
            defaultView: 'list',
            width: 800,
            contextmenu: {
                // navbarfolder menu
                navbar: [],
                // current directory menu
                cwd: [],
                // current directory file menu
                files: [
                    'getfile', '|', 'info'
                ]
            },
            uiOptions: {
                toolbar: [
                    ['search']
                ]
            },
            commandsOptions: {
                getfile: {
                    oncomplete: 'destroy'
                }
            },
            getFileCallback: function (url) {

                var fieldElm = win.document.getElementById(id);
                fieldElm.value = decodeURIComponent(url.substring(1)); // editor.convertURL(url, null, false);
                if ("fireEvent"in fieldElm) {
                    fieldElm.fireEvent("onchange")
                } else {
                    var evt = document.createEvent("HTMLEvents");
                    evt.initEvent("change", false, true);
                    fieldElm.dispatchEvent(evt)
                }
            }
        });
    };
}, ["elfinder/js"]);